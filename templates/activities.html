<!DOCTYPE html>
{% load static %}
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ç¤¾å›¢æ´»åŠ¨ - æ ¡å›­ç»¼åˆæœåŠ¡å¹³å°</title>
    <link rel="stylesheet" href="{% static 'css/common.css' %}">
    <link rel="stylesheet" href="{% static 'css/animations.css' %}">
    <link rel="stylesheet" href="{% static 'css/activities-css.css' %}">
    <link rel="stylesheet" href="{% static 'css/homepage-css.css' %}">
    <link rel="stylesheet" href="{% static 'css/decorations.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="{% static 'js/jquery-3.7.1.js' %}"></script>
</head>
<body class="activities">
<!-- é¡µé¢åŠ è½½åŠ¨ç”» -->
<div class="page-loader">
    <div class="loader-content">
        <div class="loader"></div>
        <p class="fade-in">åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...</p>
    </div>
</div>

<!-- æ»šåŠ¨è¿›åº¦æ¡ -->
<div class="scroll-progress"></div>

<!-- è£…é¥°èƒŒæ™¯ -->
<div class="flowing-background">
    <div class="decorative-line"></div>
    <div class="decorative-line"></div>
    <div class="decorative-line"></div>
    <div class="decorative-line"></div>
    <div class="decorative-shape"></div>
    <div class="decorative-shape"></div>
    <div class="decorative-shape"></div>
    <img src="{% static 'images/book-logo.svg' %}" class="mini-logo" alt="è£…é¥°">
    <img src="{% static 'images/chat-logo.svg' %}" class="mini-logo" alt="è£…é¥°">
    <img src="{% static 'images/heart-logo.svg' %}" class="mini-logo" alt="è£…é¥°">
    <!-- æ·»åŠ 20ä¸ªè£…é¥°ç‚¹ -->
    {% for i in "12345678901234567890" %}
    <div class="decorative-dot"></div>
    {% endfor %}
    <div class="wave"></div>
    <div class="wave"></div>
</div>

<!-- æ–°å¢æµåŠ¨æ•ˆæœå…ƒç´  -->
<div class="particle-system">
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
</div>

<div class="flow-line"></div>
<div class="flow-line"></div>
<div class="flow-line"></div>
<div class="flow-line"></div>
<div class="flow-line"></div>

<div class="glow-spot"></div>
<div class="glow-spot"></div>
<div class="glow-spot"></div>
<div class="glow-spot"></div>
<div class="glow-spot"></div>

<div class="ripple-ring"></div>
<div class="ripple-ring"></div>
<div class="ripple-ring"></div>
<div class="ripple-ring"></div>

<!-- é¡¶éƒ¨å¯¼èˆªæ  -->
<header>
    <div class="navbar">
        <div class="nav-links">
            <ul>
                <li><a href="{% url 'homepage:homepage' %}">é¦–é¡µ</a></li>
                <li><a href="{% url 'activities:activities' %}" class="active">ç¤¾å›¢æ´»åŠ¨</a></li>
                <li><a href="{% url 'materials:materials'%}">è¯¾ä»¶å…±äº«</a></li>
                <li><a href="{% url 'forum:forum' %}">è®ºå›</a></li>
                <li><a href="{% url 'confess:confess' %}">è¡¨ç™½å¢™</a></li>
                <li><a href="{% url 'lostfound:lost_found_page' %}">å¤±ç‰©æ‹›é¢†</a></li>
                <!-- äºŒæ‰‹å¸‚åœºåŠŸèƒ½æš‚æ—¶éšè— -->
                <li><a href="{% url 'news:news' %}">æ ¡å›­ç«æ¦œ</a></li>
            </ul>
        </div>
        <div class="user-area">
            <a href="{% url 'users:logout' %}" class="logout">é€€å‡ºç™»å½•</a>
            <!-- å½“å‰å¤´åƒ -->
            {% if user.avatar %}
            <img id="current-avatar" src="{{ user.avatar.url }}" class="avatar-circle hover-scale" alt="å¤´åƒ" onerror="this.src='/media/default_avatars/1.jpg'">
            {% elif user.default_avatar %}
            <img id="current-avatar" src="/media/{{ user.default_avatar }}" class="avatar-circle hover-scale" alt="é»˜è®¤å¤´åƒ" onerror="this.src='/media/default_avatars/1.jpg'">
            {% else %}
            <img id="current-avatar" src="/media/default_avatars/1.jpg" class="avatar-circle hover-scale" alt="é»˜è®¤å¤´åƒ">
            {% endif %}
            
            <!-- å¤´åƒé€‰æ‹©å¼¹çª— -->
            <div id="avatar-selector" class="avatar-selector hidden">
                <h3 class="avatar-selector-title">é€‰æ‹©å¤´åƒ</h3>
                <div class="avatar-grid">
                    <!-- é»˜è®¤å¤´åƒåˆ—è¡¨ -->
                    {% for i in avatar_range %}
                    <img src="/media/default_avatars/{{ i }}.jpg" class="avatar-option hover-scale" data-path="default_avatars/{{ i }}.jpg">
                    {% endfor %}
                </div>
                <!-- è‡ªå®šä¹‰å¤´åƒä¸Šä¼  -->
                <form method="post" enctype="multipart/form-data" action="{% url 'homepage:upload_avatar' %}">
                    {% csrf_token %}
                    <label class="custom-upload hover-lift">
                        <i class="fas fa-upload"></i> ä¸Šä¼ è‡ªå®šä¹‰å¤´åƒ
                        <input type="file" name="avatar" accept="image/*">
                    </label>
                </form>
            </div>
        </div>
    </div>
</header>

<!-- è‹±é›„åŒºåŸŸ -->
<section class="hero reduced-height">
    <div class="hero-content">
        <h1 class="fade-in-down">ğŸ“£ ç¤¾å›¢æ´»åŠ¨</h1>
        <p class="typing-text fade-in-up delay-300" data-speed="80" data-delay="500">ä¸Šä¼ ä½ ä»¬ç¤¾å›¢çš„æ´»åŠ¨ä¿¡æ¯ï¼Œè®©æ›´å¤šäººå‚ä¸å§ï¼</p>
        <div class="hero-cta fade-in delay-600">
            <button id="create-activity-btn" class="btn-create-activity">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 5V19" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M5 12H19" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                å‘å¸ƒæ–°æ´»åŠ¨
            </button>
        </div>
    </div>
    <div class="hero-shapes">
        <div class="hero-shape shape1"></div>
        <div class="hero-shape shape2"></div>
        <div class="hero-shape shape3"></div>
    </div>
</section>

<!-- æ´»åŠ¨å±•ç¤ºåŒºåŸŸ -->
<section class="activities-display">
    <!-- è£…é¥°æ€§è§’è½ -->
    <div class="corner corner-tl"></div>
    <div class="corner corner-tr"></div>
    <div class="corner corner-bl"></div>
    <div class="corner corner-br"></div>
    
    <h2>è¿‘æœŸæ´»åŠ¨</h2>
    
    <!-- æœç´¢æ¡† -->
    <div class="activity-search">
        <div class="search-container">
            <input type="text" id="activity-search-input" placeholder="æœç´¢æ´»åŠ¨æ ‡é¢˜ã€æ—¶é—´æˆ–åœ°ç‚¹...">
            <button id="activity-search-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 21L16.65 16.65M19 11C19 15.4183 15.4183 19 11 19C6.58172 19 3 15.4183 3 11C3 6.58172 6.58172 3 11 3C15.4183 3 19 6.58172 19 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
        <!-- éšè—è¿‡æ»¤å™¨ä½†ä¿æŒåŠŸèƒ½ -->
        <div class="search-filters hidden">
            <input type="checkbox" class="search-filter" value="title" checked>
            <input type="checkbox" class="search-filter" value="time" checked>
            <input type="checkbox" class="search-filter" value="location" checked>
        </div>
    </div>
    
    {% for activity in activities %}
    <div class="activity-card" data-id="{{ activity.id }}" data-title="{{ activity.title }}" data-time="{{ activity.datetime|date:'Y-m-d H:i' }}" data-location="{{ activity.location }}">
        <img src="{% if activity.image %}{{ activity.image.url }}{% else %}/static/images/default.jpg{% endif %}" alt="æ´»åŠ¨å°é¢" />
        <div class="activity-info">
            <h3 class="activity-title">{{ activity.title }}</h3>
            <p>ğŸ“… {{ activity.datetime|date:"Y-m-d H:i" }}<br />ğŸ“ {{ activity.location }}</p>
            <p class="activity-description">{{ activity.description }}</p>
            <div class="activity-footer">
                <p class="join-count">å·²æŠ¥åï¼š{{ activity.participant_count }} äºº</p>
            <button class="join-btn" {% if activity.has_joined %} disabled {% endif %}>
                {% if activity.has_joined %}å·²é€‰{% else %}æˆ‘æƒ³å‚åŠ {% endif %}
            </button>
            </div>
        </div>
    </div>
    {% endfor %}
</section>
    
<!-- é—´éš”åŒºåŸŸ -->
<div class="spacer"></div>

<!-- æ´»åŠ¨ä¸Šä¼ æ¨¡æ€æ¡† -->
<div class="modal" id="activity-upload-modal">
    <div class="modal-content">
        <button class="close-modal">&times;</button>
        <h2>ä¸Šä¼ æ–°æ´»åŠ¨</h2>
        <form method="post" enctype="multipart/form-data" action="{% url 'activities:create_activity' %}" class="upload-form">
            {% csrf_token %}
            {% if form.errors %}
            <div class="form-errors">
                è¯·ä¿®æ­£ä»¥ä¸‹é”™è¯¯ï¼š
                <ul>
                    {% for field in form %}
                    {% for error in field.errors %}
                    <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                    {% endfor %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            {{ form.as_p }}

            <div class="center-btn">
                <button type="submit" class="upload-btn">ä¸Šä¼ æ´»åŠ¨</button>
            </div>
        </form>
        
        <div class="auth-note" style="margin-top: 20px; font-size: 13px; color: #666; border-top: 1px solid #eee; padding-top: 15px;">
        </div>
    </div>
</div>

<!-- é”™è¯¯å¼¹çª— -->
<div id="error-popup">
    <div class="popup-content">
        <p id="error-message"></p>
        <button id="close-error-btn">å…³é—­</button>
    </div>
</div>

<!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<button class="scroll-to-top hover-scale">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 19V5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M5 12L12 5L19 12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
</button>

<!-- æ·»åŠ æ´»åŠ¨è¯¦æƒ…å¼¹çª— -->
<div class="activity-modal">
    <div class="activity-modal-content">
        <span class="close-activity-modal">&times;</span>
        <div class="activity-modal-header">
            <h2 id="modal-activity-title"></h2>
            <div class="activity-meta">
                <p id="modal-activity-time"></p>
                <p id="modal-activity-location"></p>
            </div>
        </div>
        <div class="activity-modal-body">
            <div class="activity-modal-image">
                <img id="modal-activity-image" src="" alt="æ´»åŠ¨å›¾ç‰‡">
            </div>
            <div class="activity-modal-description">
                <h3>æ´»åŠ¨è¯¦æƒ…</h3>
                <p id="modal-activity-description"></p>
            </div>
        </div>
        <div class="activity-modal-footer">
            <p class="join-count" id="modal-join-count"></p>
            <button class="join-btn" id="modal-join-btn"></button>
        </div>
    </div>
</div>

<!-- å›¾ç‰‡æ”¾å¤§æŸ¥çœ‹å¼¹çª— -->
<div class="image-zoom-overlay">
    <span class="close-zoom">&times;</span>
    <img class="zoomed-image" src="" alt="æ”¾å¤§çš„å›¾ç‰‡">
</div>

<script src="{% static 'js/jquery-3.7.1.js' %}"></script>
<script src="{% static 'js/scroll-animations.js' %}"></script>
<script src="{% static 'js/avatar-handler.js' %}"></script>
<script>
$(function() {
    // åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸ºç¤¾å›¢è´¦æˆ·
    var isClubMember = "{{ request.user.is_club_account|yesno:'true,false' }}";
    if (isClubMember === "true") {
        isClubMember = true;
    } else {
        isClubMember = false;
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåéšè—åŠ è½½åŠ¨ç”»
    $('.page-loader').addClass('loaded');
    setTimeout(function() {
        $('.page-loader').hide();
    }, 500);

    // é€€å‡ºç™»å½•ç¡®è®¤
    $('.logout').click(function(e) {
        e.preventDefault();
        const confirmed = confirm("ç¡®å®šé€€å‡ºç™»å½•å—ï¼Ÿ");
        if (confirmed) {
            window.location.href = this.href;
        }
    });

    // æ˜¾ç¤º/éšè—ä¸Šä¼ æ¨¡æ€æ¡†
    $('#create-activity-btn').click(function() {
        if (isClubMember) {
            // ç¤¾å›¢è´¦æˆ·å¯ä»¥å‘å¸ƒæ´»åŠ¨
            $('#activity-upload-modal').css('display', 'flex');
        } else {
            // æ™®é€šç”¨æˆ·æ˜¾ç¤ºé”™è¯¯æç¤º
            $('#error-message').text('åªæœ‰ç¤¾å›¢è´¦å·æ‰èƒ½å‘å¸ƒæ´»åŠ¨');
            $('#error-popup').css('display', 'flex');
        }
    });

    // å…³é—­æ¨¡æ€æ¡†
    $('.close-modal').click(function() {
        $('#activity-upload-modal').css('display', 'none');
    });

    // æœç´¢æ´»åŠ¨åŠŸèƒ½
    $('#activity-search-btn').click(function() {
        searchActivities();
    });

    $('#activity-search-input').keypress(function(e) {
        if (e.which === 13) {
            searchActivities();
        }
    });

    function searchActivities() {
        var searchText = $('#activity-search-input').val().toLowerCase();
        
        // è·å–é€‰ä¸­çš„è¿‡æ»¤é€‰é¡¹
        var filters = [];
        $('.search-filter:checked').each(function() {
            filters.push($(this).val());
        });
        
        // å¦‚æœæ²¡æœ‰é€‰ä¸­ä»»ä½•è¿‡æ»¤é€‰é¡¹ï¼Œåˆ™é»˜è®¤æœç´¢æ‰€æœ‰å­—æ®µ
        if (filters.length === 0) {
            filters = ['title', 'time', 'location'];
        }
        
        $('.activity-card').each(function() {
            var matchFound = false;
            
            // æ ¹æ®è¿‡æ»¤å™¨æœç´¢ç›¸åº”å­—æ®µ
            if (filters.includes('title') && $(this).data('title').toLowerCase().includes(searchText)) {
                matchFound = true;
            }
            if (filters.includes('time') && $(this).data('time').toLowerCase().includes(searchText)) {
                matchFound = true;
            }
            if (filters.includes('location') && $(this).data('location').toLowerCase().includes(searchText)) {
                matchFound = true;
            }
            
            // æ˜¾ç¤ºæˆ–éšè—æ´»åŠ¨å¡ç‰‡
            if (matchFound || searchText === '') {
                $(this).removeClass('hidden');
            } else {
                $(this).addClass('hidden');
            }
        });
    }
    
    // å…³é—­é”™è¯¯æç¤º
    $('#close-error-btn').click(function() {
        $('#error-popup').css('display', 'none');
    });

    // å¤„ç†æ´»åŠ¨æŠ¥å
    $('.join-btn').click(function(e) {
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘å¡ç‰‡ç‚¹å‡»
        var activityId = $(this).closest('.activity-card').data('id');
        var button = $(this);
        var isJoined = button.text() === 'å·²é€‰';
        
        $.ajax({
            url: "{% url 'activities:join_activity' 0 %}".replace('0', activityId),
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    if (response.joined) {
                        button.text('å·²é€‰').prop('disabled', true);
                    } else {
                        button.text('æˆ‘æƒ³å‚åŠ ').prop('disabled', false);
                    }
                    // æ›´æ–°æŠ¥åäººæ•°
                    button.closest('.activity-footer').find('.join-count').text('å·²æŠ¥åï¼š' + response.participants_count + ' äºº');
                } else {
                    $('#error-message').text(response.message || 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                    $('#error-popup').css('display', 'flex');
                }
            },
            error: function() {
                $('#error-message').text('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
                $('#error-popup').css('display', 'flex');
            }
        });
    });

    // æ˜¾ç¤ºå¼¹çª—ä¸­çš„æŠ¥åæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    $('#modal-join-btn').click(function() {
        var activityId = $(this).data('activity-id');
        var button = $(this);
        
        $.ajax({
            url: "{% url 'activities:join_activity' 0 %}".replace('0', activityId),
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    if (response.joined) {
                        button.text('å·²é€‰').prop('disabled', true);
                    } else {
                        button.text('æˆ‘æƒ³å‚åŠ ').prop('disabled', false);
                    }
                    
                    // æ›´æ–°å¼¹çª—ä¸­çš„æŠ¥åäººæ•°
                    $('#modal-join-count').text('å·²æŠ¥åï¼š' + response.participants_count + ' äºº');
                    
                    // æ›´æ–°å¡ç‰‡ä¸­çš„æŒ‰é’®å’ŒæŠ¥åäººæ•°
                    var card = $('.activity-card[data-id="' + activityId + '"]');
                    if (response.joined) {
                        card.find('.join-btn').text('å·²é€‰').prop('disabled', true);
                    } else {
                        card.find('.join-btn').text('æˆ‘æƒ³å‚åŠ ').prop('disabled', false);
                    }
                    card.find('.join-count').text('å·²æŠ¥åï¼š' + response.participants_count + ' äºº');
            } else {
                    $('#error-message').text(response.message || 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                    $('#error-popup').css('display', 'flex');
                }
            },
            error: function() {
                $('#error-message').text('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
                $('#error-popup').css('display', 'flex');
            }
        });
    });

    // å›åˆ°é¡¶éƒ¨æŒ‰é’®
    $(window).scroll(function() {
        if ($(this).scrollTop() > 300) {
            $('.scroll-to-top').addClass('visible');
        } else {
            $('.scroll-to-top').removeClass('visible');
        }
        
        // æ›´æ–°æ»šåŠ¨è¿›åº¦æ¡
        var scrollPercent = ($(window).scrollTop() / ($(document).height() - $(window).height())) * 100;
        $('.scroll-progress').css('width', scrollPercent + '%');
    });
    
    $('.scroll-to-top').click(function() {
        $('html, body').animate({
            scrollTop: 0
        }, 500);
        return false;
    });

    // ç‚¹å‡»æ´»åŠ¨å¡ç‰‡æ‰“å¼€è¯¦æƒ…å¼¹çª—
    $('.activity-card').click(function(e) {
        // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸æ‰“å¼€å¼¹çª—
        if ($(e.target).closest('.join-btn').length) {
            return;
        }
        
        var activityId = $(this).data('id');
        var activityTitle = $(this).data('title');
        var activityTime = $(this).data('time');
        var activityLocation = $(this).data('location');
        var activityDescription = $(this).find('.activity-description').text();
        var activityImage = $(this).find('img').attr('src');
        var joinCount = $(this).find('.join-count').text();
        var joinBtnText = $(this).find('.join-btn').text();
        var joinBtnDisabled = $(this).find('.join-btn').prop('disabled');
        
        // å¡«å……å¼¹çª—å†…å®¹
        $('#modal-activity-title').text(activityTitle);
        $('#modal-activity-time').text('ğŸ“… ' + activityTime);
        $('#modal-activity-location').text('ğŸ“ ' + activityLocation);
        $('#modal-activity-description').text(activityDescription);
        $('#modal-activity-image').attr('src', activityImage);
        $('#modal-join-count').text(joinCount);
        $('#modal-join-btn').text(joinBtnText).prop('disabled', joinBtnDisabled).data('activity-id', activityId);
        
        // æ˜¾ç¤ºå¼¹çª—
        $('.activity-modal').css('display', 'flex');
        
        // é˜²æ­¢æ»šåŠ¨ç©¿é€
        $('body').css('overflow', 'hidden');
    });
    
    // å…³é—­æ´»åŠ¨è¯¦æƒ…å¼¹çª—
    $('.close-activity-modal').click(function() {
        $('.activity-modal').css('display', 'none');
        $('body').css('overflow', 'auto');
    });
    
    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­å¼¹çª—
    $('.activity-modal').click(function(e) {
        if ($(e.target).closest('.activity-modal-content').length === 0) {
            $('.activity-modal').css('display', 'none');
            $('body').css('overflow', 'auto');
        }
    });

    // ç‚¹å‡»å¼¹çª—ä¸­çš„å›¾ç‰‡æ”¾å¤§æŸ¥çœ‹
    $(document).on('click', '.activity-modal-image', function() {
        var imgSrc = $(this).find('img').attr('src');
        $('.zoomed-image').attr('src', imgSrc);
        $('.image-zoom-overlay').css('display', 'flex');
        $('body').css('overflow', 'hidden');
    });
    
    // å…³é—­æ”¾å¤§å›¾ç‰‡
    $('.close-zoom').click(function() {
        $('.image-zoom-overlay').css('display', 'none');
        $('body').css('overflow', 'auto');
    });
    
    // ç‚¹å‡»å›¾ç‰‡å¤–åŒºåŸŸå…³é—­æ”¾å¤§å›¾ç‰‡
    $('.image-zoom-overlay').click(function(e) {
        if (e.target === this) {
            $(this).css('display', 'none');
            $('body').css('overflow', 'auto');
        }
    });
});
</script>
</body>
</html>
